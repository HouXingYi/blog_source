<!DOCTYPE html>
<html>
  <head>
      
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/mongodb/2017/10/30/populate.html">
  <link rel="alternate" type="application/rss+xml" title="侯星伊的个人博客" href="http://localhost:4000/feed.xml">

<!-- Google font -->

  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Noto Sans">

<!-- font awesome -->

<link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">

</head>


  

  

  </head>

  <body>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>mongoose之Population</title>
  <meta name="description" content="在MongoDB中没有关系型数据库的join特性，所以在document进行相互关联的时候就比较麻烦。">
</head>


  <div class="wrapper">
          <header class="post-header">

    <center><div class="post-title" itemprop="name headline">mongoose之Population</div>

		<div class="post-meta"><i class="fa fa-calendar-o"></i> <time datetime="30 Oct 2017" itemprop="datePublished">Oct 30 2017</time>

		&nbsp;&nbsp;•&nbsp;&nbsp;<i class="fa fa-user-secret"></i> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">HouXingYi</span>
        
		<br>
		<!--<i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-pulse"></i></span>˚C</span>-->
	</div>

        
        <div class="post-tags">
        
		<a class="post-tags-item" href="http://localhost:4000/tags/">mongoose</a>
        
		<a class="post-tags-item" href="http://localhost:4000/tags/">populate</a>
        
	</div>
    </center>
    
</header>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content">
    <center>
	
	<p></p>
	
    </center>
	<h2>Directory</h2>
</div>

<div id="category"></div>

<div class="post-content" itemprop="articleBody">
    <p>在MongoDB中没有关系型数据库的join特性，所以在document进行相互关联的时候就比较麻烦。</p>

<p>在mongoose中有一个<code class="highlighter-rouge">population</code>用于解决这类问题。在定义<code class="highlighter-rouge">Schema</code>的时候，如果设置某个<code class="highlighter-rouge">field</code>关联另一个<code class="highlighter-rouge">Schema</code>，那么在获取<code class="highlighter-rouge">document</code>的时候就可以使用<code class="highlighter-rouge">Population</code>功能通过关联<code class="highlighter-rouge">Schema</code>的<code class="highlighter-rouge">field</code>找到关联的另一个<code class="highlighter-rouge">document</code>，并且用被关联<code class="highlighter-rouge">document</code>的内容替换掉原来关联<code class="highlighter-rouge">field</code>的内容。</p>

<h2 id="例子">例子</h2>

<p>下面我拿官方的例子来说明</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var mongoose = require('mongoose');
var Schema = mongoose.Schema;

var personSchema = Schema({
  _id: Schema.Types.ObjectId,
  name: String,
  age: Number,
  stories: [{ type: Schema.Types.ObjectId, ref: 'Story' }]
});

var storySchema = Schema({
  author: { type: Schema.Types.ObjectId, ref: 'Person' },
  title: String,
  fans: [{ type: Schema.Types.ObjectId, ref: 'Person' }]
});

var Story = mongoose.model('Story', storySchema);
var Person = mongoose.model('Person', personSchema);
</code></pre>
</div>

<p>首先先定义两个model，并且这两个model的schema相互引用。可以看到在person的stories字段（field ）中我们定义了数组，表示关联的数据解析为数组。其中ref选项告诉mongoose在使用populate的时候使用什么model，并且后续所有的传入的_id都要在这个model之中。</p>

<h2 id="保存数据">保存数据</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>var author = new Person({
  _id: new mongoose.Types.ObjectId(),
  name: 'Ian Fleming',
  age: 50
});

author.save(function (err) {
  if (err) return handleError(err);
  
  var story1 = new Story({
    title: 'Casino Royale',
    author: author._id    // assign the _id from the person
  });
  
  story1.save(function (err) {
    if (err) return handleError(err);
    // thats it!
  });
});
</code></pre>
</div>

<p>保存数据的时候并没有什么不同，只是记得要分配下_id，若是_ids,则把所有需要展现的document的_id做成一个数组传入。</p>

<h2 id="解析出引用">解析出引用</h2>

<p>上面做的一些操作并没有什么特别的，但接下来我们可以看到通过populate我们解析除了内嵌的关联document。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Story.
  findOne({ title: 'Casino Royale' }).
  populate('author').
  exec(function (err, story) {
    if (err) return handleError(err);
    console.log('The author is %s', story.author.name);
    // prints "The author is Ian Fleming"
  });
</code></pre>
</div>

<p>下面我说下populate方法的常用用法</p>

<h2 id="querypopulate">Query#populate</h2>

<p>就是查询语句之后可以调用populate</p>

<p>语法</p>
<div class="highlighter-rouge"><pre class="highlight"><code>**`Query.populate(path, [select], [model], [match], [options])`**
</code></pre>
</div>
<p>参数</p>

<ul>
  <li>path</li>
</ul>

<p>类型：<code class="highlighter-rouge">String</code>或<code class="highlighter-rouge">Object</code>。</p>

<p>String类型的时， 指定要填充的关联字段，要填充多个关联字段可以以空格分隔。</p>

<p>Object类型的时，就是把 populate 的参数封装到一个对象里。当然也可以是个数组。下面的例子中将会实现。</p>

<ul>
  <li>select</li>
</ul>

<p>类型：<code class="highlighter-rouge">Object</code>或<code class="highlighter-rouge">String</code>，可选，指定填充 document 中的哪些字段。</p>

<p>Object类型的时，格式如:{name: 1, _id: 0},为0表示不填充，为1时表示填充。
　　
String类型的时，格式如:”name -_id”，用空格分隔字段，在字段名前加上-表示不填充。详细语法介绍 query-select</p>

<ul>
  <li>model</li>
</ul>

<p>类型：Model，可选，指定关联字段的 model，如果没有指定就会使用Schema的ref。</p>

<ul>
  <li>match</li>
</ul>

<p>类型：Object，可选，指定附加的查询条件。</p>

<ul>
  <li>options</li>
</ul>

<p>类型：Object，可选，指定附加的其他查询选项，如排序以及条数限制等等。</p>

<p>例子</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//填充所有 users 的 posts
User.find()
    .populate('posts', 'title', null, {sort: { title: -1 }})
    .exec(function(err, docs) {
        console.log(docs[0].posts[0].title); // post-by-aikin
    });

//填充 user 'luajin'的 posts
User.findOne({name: 'luajin'})
    .populate({path: 'posts', select: { title: 1 }, options: {sort: { title: -1 }}})
    .exec(function(err, doc) {
        console.log(doc.posts[0].title);  // post-by-luajin
    });

//这里的 populate 方法传入的参数形式不同，其实实现的功能是一样的，只是表示形式不一样。
</code></pre>
</div>

<h2 id="modelpopulate">Model#populate</h2>

<p>model直接调用populate</p>

<p>语法</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**`Model.populate(docs, options, [cb(err,doc)])`**
</code></pre>
</div>

<p>参数</p>

<ul>
  <li>docs</li>
</ul>

<p>类型：Document或Array。单个需要被填充的 doucment 或者 document 的数组。</p>

<ul>
  <li>options</li>
</ul>

<p>类型：Object。以键值对的形式表示。</p>

<p>keys：path select match model options，这些键对应值的类型和功能，与上述Query#populate方法的参数相同。</p>

<ul>
  <li>[cb(err,doc)]</li>
</ul>

<p>类型：Function，回调函数，接收两个参数，错误err和填充完的doc(s)。</p>

<p>例子</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Post.find({title: 'post-by-aikin'})
    .populate('poster comments')
    .exec(function(err, docs) {

        var opts = [{
            path   : 'comments.commenter',
            select : 'name',
            model  : 'User'
        }];

        Post.populate(docs, opts, function(err, populatedDocs) {
            console.log(populatedDocs[0].poster.name);                  // aikin
            console.log(populatedDocs[0].comments[0].commenter.name);  // luna
        });
    });
</code></pre>
</div>

<h2 id="documentpopulate">Document#populate</h2>

<p>document直接调用populate</p>

<p>语法</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**`Document.populate([path], [callback])`**
</code></pre>
</div>

<p>参数</p>

<ul>
  <li>path</li>
</ul>

<p>类型：String或Object。与上述Query#populate`方法的 path 参数相同。</p>

<ul>
  <li>callback</li>
</ul>

<p>类型：Function。回调函数，接收两个参数，错误err和填充完的doc(s)。</p>

<p>例子</p>

<div class="highlighter-rouge"><pre class="highlight"><code>User.findOne({name: 'aikin'})
    .exec(function(err, doc) {

        var opts = [{
            path   : 'posts',
            select : 'title'
        }];

        doc.populate(opts, function(err, populatedDoc) {
            console.log(populatedDoc.posts[0].title);  // post-by-aikin
        });
    });
</code></pre>
</div>

<h2 id="跨越等级的populate">跨越等级的Populate</h2>

<p>populate可以进行多重引用</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var userSchema = new Schema({
  name: String,
  friends: [{ type: ObjectId, ref: 'User' }]
});

User.
  findOne({ name: 'Val' }).
  populate({
    path: 'friends',
    // Get friends of friends - populate the 'friends' array for every friend
    populate: { path: 'friends' }
  });
</code></pre>
</div>

<h2 id="参考">参考</h2>

<p><a href="http://mongoosejs.com/docs/populate.html">官方starter</a></p>

<p><a href="https://segmentfault.com/a/1190000002727265">Mongoose 之 Population 使用</a></p>


</div>

<div>
	
	<div class="eof"></div>
	
</div>

<!--先不分享-->
<!-- <div class="share">
    <p>Share this post with: </p>
	<a href="https://twitter.com/intent/tweet?text=mongoose之Population@&amp;url=http://localhost:4000/mongodb/2017/10/30/populate.html" class="twitter-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/mongodb/2017/10/30/populate.html" class="facebook-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://plus.google.com/share?url=http://localhost:4000/mongodb/2017/10/30/populate.html" class="googleplus-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</span>
	</a>
</div>
 -->

<!-- <div id="disqus_thread"></div>


 
</div>
  -->


<div id="container"></div>
<link rel="stylesheet" href="http://localhost:4000/gitment/default.css">
<script src="http://localhost:4000/gitment/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id:window.location.pathname,
  owner: 'HouXingYi',
  repo: 'HouXingYi.github.io',
  oauth: {
    client_id: 'd8225497d80663e0c270',
    client_secret: '748c7dd30b4c86dd92fe7176d4a60e5d44ee405e',
  },
})
gitment.render('container')
</script>


</article>

  </div>

</body>

<foot>

    <footer class="site-footer">

  <div class="wrapper">

    <center>
        
		<p>
		 <a class="link" href="/index.html">index</a> /
		 <a class="link" href="/archive/">Archive</a> /
		 <a class="link" href="/category/">Category</a> / 
		 <a class="link" href="/tags/">Tags</a> / 
		 <a class="link" href="/about/">About</a> 
		<!--/-->
		<!--<a class="link" href="/contact/">Contact</a>-->
        </p>

        <span><script>document.write(new Date().getFullYear());</script></span>
        <span>&copy;</span>
        
		<a class="link" href="">HouXingYi</a>
		<br>
		<span>Theme &copy; <a class="link" href="https://twitter.com/itisbenjamin1" target="_blank"> Ben</a> | </span>
				<iframe
			style="margin-left: 2px; margin-bottom:-5px;"
			frameborder="0" scrolling="0" width="91px" height="20px"
			src="https://ghbtns.com/github-btn.html?user=itisbenjamin&repo=Nice_Blog&type=star&count=true" >
		</iframe>
		<br>
		<span>一共被点击<span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-pulse"></i></span>次</span>
		<span>一共访问人数<span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-pulse"></i></span>次</span>
    </center>
    
  </div>

</footer>

    <foot>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Derictory -->

<!-- Hit analytics -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Directory -->

<script src="/js/jquery-1.7.2.min.js"></script>
<script src="/js/highlight.min.js"></script>
<script src="/js/main.js"></script>

</foot>


</foot>

</html>
